name: C/C++ CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build-x86:
    name: Build on x86_64 (syntax check only)
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc
    
    - name: Syntax check vector summation
      run: gcc -fsyntax-only -faltivec -maltivec G5.c
      continue-on-error: true
    
    - name: Syntax check vector summation with tests
      run: gcc -fsyntax-only -faltivec -maltivec -DTEST_VEC_SUM G5.c
      continue-on-error: true
    
    - name: Syntax check FIR filter
      run: gcc -fsyntax-only -faltivec -maltivec G5_fir.c
      continue-on-error: true
    
    - name: Syntax check FIR filter with tests
      run: gcc -fsyntax-only -faltivec -maltivec -DTEST_FIR_FILTER G5_fir.c
      continue-on-error: true
    
    - name: Syntax check GEMV
      run: gcc -fsyntax-only -faltivec -maltivec G5_gemv.c
      continue-on-error: true
    
    - name: Syntax check GEMV with tests
      run: gcc -fsyntax-only -faltivec -maltivec -DTEST_GEMV G5_gemv.c
      continue-on-error: true

  build-powerpc:
    name: Build and test on PowerPC
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Install cross-compilation toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-powerpc-linux-gnu qemu-user qemu-user-static
    
    - name: Build vector summation (object file)
      run: powerpc-linux-gnu-gcc -O3 -c -maltivec -mabi=altivec G5.c -o vec_sum.o

    - name: Build vector summation test executable
      run: powerpc-linux-gnu-gcc -O3 -static -maltivec -mabi=altivec -DTEST_VEC_SUM G5.c -o vec_sum_test -lm

    - name: Build FIR filter (object file)
      run: powerpc-linux-gnu-gcc -O3 -c -maltivec -mabi=altivec G5_fir.c -o fir_filter.o

    - name: Build FIR filter test executable
      run: powerpc-linux-gnu-gcc -O3 -static -maltivec -mabi=altivec -DTEST_FIR_FILTER G5_fir.c -o fir_filter_test -lm

    - name: Build GEMV (object file)
      run: powerpc-linux-gnu-gcc -O3 -c -maltivec -mabi=altivec G5_gemv.c -o gemv.o

    - name: Build GEMV test executable
      run: powerpc-linux-gnu-gcc -O3 -static -maltivec -mabi=altivec -DTEST_GEMV G5_gemv.c -o gemv_test -lm
    
    - name: Test vector summation
      run: qemu-ppc -cpu G4 ./vec_sum_test
      continue-on-error: true
    
    - name: Test FIR filter
      run: qemu-ppc -cpu G4 ./fir_filter_test
      continue-on-error: true
    
    - name: Test GEMV
      run: qemu-ppc -cpu G4 ./gemv_test
      continue-on-error: true
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: powerpc-binaries
        path: |
          *.o
          *_test

  lint:
    name: Code quality checks
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    
    - name: Install clang tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format clang-tidy
    
    - name: Check code formatting
      run: |
        find . -name "*.c" -o -name "*.h" | xargs clang-format --dry-run --Werror
      continue-on-error: true
    
    - name: Run static analysis
      run: |
        clang-tidy G5.c G5_fir.c G5_gemv.c -- -maltivec
      continue-on-error: true
